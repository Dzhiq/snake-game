<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>é«˜çº§è´ªåƒè›‡</title>

<style>
body{
    margin:0;
    background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    font-family:Arial, sans-serif;
    color:#fff;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    overflow: hidden; /* é˜²æ­¢é¡µé¢å‡ºç°æ»šåŠ¨æ¡ */
}

.game-box{
    text-align:center;
    position: relative; /* ä¸ºæ‘‡æ†å®šä½åšå‡†å¤‡ */
}

canvas{
    background:#000;
    border-radius:12px;
    box-shadow:0 0 20px rgba(0,0,0,0.6);
    display: block; /* é¿å…å†…è”å…ƒç´ å¯èƒ½äº§ç”Ÿçš„é—´éš™ */
    margin: 0 auto;
}

h1{margin:8px 0;}

.info{
    margin:6px 0;
}

button{
    padding:10px 20px;
    border:none;
    border-radius:8px;
    background:#4CAF50;
    color:#fff;
    font-size:16px;
    cursor:pointer;
    margin: 5px;
}
button:hover{background:#45a049;}

.overlay{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.7);
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    z-index: 10; /* ç¡®ä¿è¦†ç›–å±‚åœ¨æœ€ä¸Šå±‚ */
}

.hidden{display:none;}

/* æ–°å¢ä½œè€…ä¿¡æ¯æ ·å¼ */
.author {
    margin-top: 10px;
    font-size: 14px;
    color: #cccccc; /* æµ…ç°è‰²ï¼Œä¸èƒŒæ™¯å¯¹æ¯”ä¸”ä¸å–§å®¾å¤ºä¸» */
}

/* éš¾åº¦é€‰æ‹©å®¹å™¨æ ·å¼ */
.difficulty-container {
    margin: 10px 0;
}

.difficulty-btn {
    padding: 8px 16px;
    font-size: 14px;
    background-color: #6c757d; /* é»˜è®¤ç°è‰² */
}

.difficulty-btn.active {
    background-color: #007bff; /* é€‰ä¸­æ—¶è“è‰² */
}

/* æ‘‡æ†å®¹å™¨æ ·å¼ */
.joystick-container {
    position: absolute;
    bottom: 20px; /* è·ç¦»åº•éƒ¨çš„è·ç¦» */
    left: 20px; /* è·ç¦»å·¦è¾¹çš„è·ç¦» */
    width: 100px; /* åŸºåº§å®½åº¦ */
    height: 100px; /* åŸºåº§é«˜åº¦ */
    pointer-events: none; /* è®©å®¹å™¨æœ¬èº«ä¸å½±å“è§¦æ‘¸äº‹ä»¶ */
}

.joystick-base {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%; /* åœ†å½¢ */
    background: rgba(255, 255, 255, 0.1); /* åŠé€æ˜ç™½è‰² */
    backdrop-filter: blur(5px); /* æ¨¡ç³ŠèƒŒæ™¯ */
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.joystick-handle {
    position: absolute;
    top: calc(50% - 20px); /* é«˜åº¦çš„ä¸€åŠå‡å»è‡ªèº«ä¸€åŠ */
    left: calc(50% - 20px); /* å®½åº¦çš„ä¸€åŠå‡å»è‡ªèº«ä¸€åŠ */
    width: 40px;
    height: 40px;
    border-radius: 50%; /* åœ†å½¢ */
    background: rgba(255, 255, 255, 0.3); /* åŠé€æ˜ç°è‰² */
    backdrop-filter: blur(3px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    transform: translate(-50%, -50%); /* å±…ä¸­å¯¹é½ */
    pointer-events: none; /* è®©æ‰‹æŸ„æœ¬èº«ä¸å½±å“è§¦æ‘¸äº‹ä»¶ */
}

</style>
</head>

<body>

<div class="game-box">
    <h1>ğŸ è´ªåƒè›‡</h1>
    <div class="info">å¾—åˆ†ï¼š<span id="score">0</span> | æœ€é«˜åˆ†ï¼š<span id="best">0</span></div>
    
    <!-- éš¾åº¦é€‰æ‹©æŒ‰é’® -->
    <div class="difficulty-container">
        <button id="easyBtn" class="difficulty-btn active" onclick="setDifficulty('easy')">ç®€å•</button>
        <button id="normalBtn" class="difficulty-btn" onclick="setDifficulty('normal')">ä¸€èˆ¬</button>
        <button id="hardBtn" class="difficulty-btn" onclick="setDifficulty('hard')">å›°éš¾</button>
    </div>

    <canvas id="game" width="320" height="320"></canvas>
    
    <!-- è™šæ‹Ÿæ‘‡æ†å®¹å™¨ -->
    <div id="joystickContainer" class="joystick-container">
        <div class="joystick-base"></div>
        <div class="joystick-handle"></div>
    </div>
    
    <br/>
    <!-- æ–°å¢ä½œè€…ä¿¡æ¯æ˜¾ç¤º -->
    <p class="author">Authorï¼šdzq</p>
    <button id="startButton" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
</div>

<div id="gameOver" class="overlay hidden">
    <h2>æ¸¸æˆç»“æŸ</h2>
    <p id="finalScore"></p>
    <button onclick="restartGame()">å†æ¥ä¸€æ¬¡</button>
    <button onclick="backToMenu()">è¿”å›èœå•</button>
</div>

<audio id="eatSound" src="https://cdn.jsdelivr.net/gh/naptha/tiny-sound@master/eat.mp3"></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const grid = 16;

let snake, food, dx, dy, score, timer;

// éš¾åº¦ç›¸å…³å˜é‡
let currentDifficulty = 'normal'; // é»˜è®¤éš¾åº¦
const difficultySettings = {
    easy: { speed: 180 },    // ç®€å•ï¼šè¾ƒæ…¢ï¼Œ180ms
    normal: { speed: 120 },  // ä¸€èˆ¬ï¼šä¸­ç­‰ï¼Œ120ms
    hard: { speed: 70 }      // å›°éš¾ï¼šè¾ƒå¿«ï¼Œ70ms
};

// éš¾åº¦æŒ‰é’®å…ƒç´ 
const easyBtn = document.getElementById('easyBtn');
const normalBtn = document.getElementById('normalBtn');
const hardBtn = document.getElementById('hardBtn');
const startButton = document.getElementById('startButton');

const scoreEl = document.getElementById("score");
const bestEl = document.getElementById("best");
const overBox = document.getElementById("gameOver");
const finalScore = document.getElementById("finalScore");
const eatSound = document.getElementById("eatSound");

// æ‘‡æ†ç›¸å…³å…ƒç´ 
const joystickContainer = document.getElementById('joystickContainer');
const joystickBase = joystickContainer.querySelector('.joystick-base');
const joystickHandle = joystickContainer.querySelector('.joystick-handle');

// æ‘‡æ†çŠ¶æ€å˜é‡
let isJoystickActive = false;
let joystickBaseRect;
let baseCenterX, baseCenterY;
let maxDistance; // æ‘‡æ†æ´»åŠ¨èŒƒå›´çš„æœ€å¤§è·ç¦»

/* æœ€é«˜åˆ† */
let best = localStorage.getItem("snake_best") || 0;
bestEl.textContent = best;

/* åˆå§‹åŒ– */
function init(){
    snake=[{x:10,y:10}];
    dx=1; dy=0;
    score=0;
    scoreEl.textContent=0;
    randomFood();
}

/* éšæœºé£Ÿç‰© */
function randomFood(){
    food={
        x:Math.floor(Math.random()*20),
        y:Math.floor(Math.random()*20)
    };
}

/* ç»˜åˆ¶ */
function draw(){
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    /* é£Ÿç‰© */
    ctx.fillStyle="#ff5252";
    ctx.fillRect(food.x*grid,food.y*grid,grid-2,grid-2);

    /* è›‡ */
    ctx.fillStyle="#4CAF50";
    snake.forEach((p,i)=>{
        ctx.globalAlpha = 1 - i*0.03;
        ctx.fillRect(p.x*grid,p.y*grid,grid-2,grid-2);
    });
    ctx.globalAlpha = 1;
}

/* æ›´æ–° */
function update(){
    const head={x:snake[0].x+dx,y:snake[0].y+dy};

    /* æ’å¢™æˆ–æ’è‡ªå·± */
    if(
        head.x<0||head.y<0||
        head.x>=20||head.y>=20||
        snake.some(p=>p.x===head.x&&p.y===head.y)
    ){
        gameOver();
        return;
    }

    snake.unshift(head);

    /* åƒé£Ÿç‰© */
    if(head.x===food.x&&head.y===food.y){
        score++;
        scoreEl.textContent=score;
        eatSound.currentTime=0;
        eatSound.play();
        randomFood();
    }else{
        snake.pop();
    }
}

/* å¾ªç¯ */
function loop(){
    update();
    draw();
}

/* è®¾ç½®éš¾åº¦ */
function setDifficulty(level) {
    currentDifficulty = level;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    easyBtn.classList.toggle('active', level === 'easy');
    normalBtn.classList.toggle('active', level === 'normal');
    hardBtn.classList.toggle('active', level === 'hard');
}

/* å¼€å§‹æ¸¸æˆ (ä»ä¸»èœå•ç‚¹å‡») */
function startGame(){
    if (!currentDifficulty) {
        setDifficulty('normal');
    }
    init();
    clearInterval(timer);
    timer = setInterval(loop, difficultySettings[currentDifficulty].speed);
    overBox.classList.add("hidden");
    // åˆå§‹åŒ–æ‘‡æ†å°ºå¯¸
    initJoystick();
}

/* é‡æ–°å¼€å§‹æ¸¸æˆ (ä½¿ç”¨å½“å‰éš¾åº¦) */
function restartGame(){
    init();
    clearInterval(timer);
    timer = setInterval(loop, difficultySettings[currentDifficulty].speed);
    overBox.classList.add("hidden");
}

/* è¿”å›ä¸»èœå• */
function backToMenu(){
    clearInterval(timer);
    overBox.classList.add("hidden");
    init();
    score = 0;
    scoreEl.textContent = score;
}

/* ç»“æŸ */
function gameOver(){
    clearInterval(timer);
    finalScore.textContent="æœ¬æ¬¡å¾—åˆ†ï¼š"+score;

    if(score>best){
        best=score;
        localStorage.setItem("snake_best",best);
        bestEl.textContent=best;
    }

    overBox.classList.remove("hidden");
}

/* é”®ç›˜æ§åˆ¶ */
document.addEventListener("keydown",e=>{
    if(e.key==="ArrowUp"&&dy===0){dx=0;dy=-1;}
    if(e.key==="ArrowDown"&&dy===0){dx=0;dy=1;}
    if(e.key==="ArrowLeft"&&dx===0){dx=-1;dy=0;}
    if(e.key==="ArrowRight"&&dx===0){dx=1;dy=0;}
});

// --- è™šæ‹Ÿæ‘‡æ†æ§åˆ¶ ---
function initJoystick() {
    // è·å–æ‘‡æ†åŸºåº§çš„å°ºå¯¸å’Œä½ç½®
    joystickBaseRect = joystickBase.getBoundingClientRect();
    baseCenterX = joystickBaseRect.left + joystickBaseRect.width / 2;
    baseCenterY = joystickBaseRect.top + joystickBaseRect.height / 2;
    maxDistance = joystickBaseRect.width / 2; // æœ€å¤§æ´»åŠ¨åŠå¾„
}

function handleTouchStart(e) {
    if (e.touches.length > 0) {
        const touch = e.touches[0];
        const touchX = touch.clientX;
        const touchY = touch.clientY;

        // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨æ‘‡æ†åŸºåº§å†…
        if (
            touchX >= joystickBaseRect.left &&
            touchX <= joystickBaseRect.right &&
            touchY >= joystickBaseRect.top &&
            touchY <= joystickBaseRect.bottom
        ) {
            isJoystickActive = true;
            moveJoystick(touchX, touchY);
        }
    }
}

function handleTouchMove(e) {
    if (isJoystickActive && e.touches.length > 0) {
        e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
        const touch = e.touches[0];
        moveJoystick(touch.clientX, touch.clientY);
    }
}

function handleTouchEnd(e) {
    if (isJoystickActive) {
        isJoystickActive = false;
        // æ‰‹æŒ‡æŠ¬èµ·åï¼Œå°†æ‰‹æŸ„å½’ä½
        joystickHandle.style.transform = `translate(-50%, -50%)`;
        joystickHandle.style.background = 'rgba(255, 255, 255, 0.3)';
    }
}

function moveJoystick(x, y) {
    const deltaX = x - baseCenterX;
    const deltaY = y - baseCenterY;
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    const angleInRadians = Math.atan2(deltaY, deltaX);
    const angleInDegrees = angleInRadians * (180 / Math.PI);

    let clampedDeltaX = deltaX;
    let clampedDeltaY = deltaY;

    // é™åˆ¶æ‰‹æŸ„åœ¨åŸºåº§èŒƒå›´å†…ç§»åŠ¨
    if (distance > maxDistance) {
        clampedDeltaX = (deltaX / distance) * maxDistance;
        clampedDeltaY = (deltaY / distance) * maxDistance;
    }

    // æ›´æ–°æ‰‹æŸ„ä½ç½®
    joystickHandle.style.transform = `translate(calc(-50% + ${clampedDeltaX}px), calc(-50% + ${clampedDeltaY}px))`;

    // æ ¹æ®è§’åº¦åˆ¤æ–­æ–¹å‘ (åŸºäºç¬›å¡å°”åæ ‡ç³»)
    // ä¸Š: -90Â° ~ -45Â°, ä¸‹: 90Â° ~ 135Â° æˆ– -90Â° ~ -135Â°, å·¦: 135Â° ~ 180Â° æˆ– -180Â° ~ -135Â°, å³: -45Â° ~ 45Â°
    // ç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨è±¡é™åˆ¤æ–­
    let newDx = 0;
    let newDy = 0;

    if (angleInDegrees >= -45 && angleInDegrees <= 45) {
        // å³
        newDx = 1;
        newDy = 0;
    } else if (angleInDegrees > 45 && angleInDegrees < 135) {
        // ä¸‹
        newDx = 0;
        newDy = 1;
    } else if (angleInDegrees >= 135 || angleInDegrees <= -135) {
        // å·¦
        newDx = -1;
        newDy = 0;
    } else {
        // ä¸Š
        newDx = 0;
        newDy = -1;
    }

    // åªæœ‰å½“æ–°æ–¹å‘ä¸å½“å‰è¿åŠ¨æ–¹å‘ä¸ç›¸åæ—¶æ‰æ›´æ–°
    if ((newDx !== 0 && dx === 0) || (newDy !== 0 && dy === 0)) {
        if (!(newDx === -dx && newDy === -dy)) { // ä¸å…è®¸åå‘
             dx = newDx;
             dy = newDy;
        }
    }
}

// æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨
canvas.addEventListener("touchstart", handleTouchStart, { passive: false }); // passive: false å…è®¸ preventDefault
canvas.addEventListener("touchmove", handleTouchMove, { passive: false });
canvas.addEventListener("touchend", handleTouchEnd);

// é¡µé¢åŠ è½½ååˆå§‹åŒ–æ‘‡æ†
window.addEventListener('load', initJoystick);
window.addEventListener('resize', initJoystick); // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—å°ºå¯¸


</script>
</body>
</html>
